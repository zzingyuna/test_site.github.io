---
layout: post
---

# MongoDB 3 !! 수정, 삭제

몽고DB는 롤백기능을 지원하지 않는다.  
대신 oplog를 통해 데이터를 되돌릴 수 있다.(oplog:데이터베이스에 어떤 쿼리를 했는지 기록으로 남겨둠)  



##### 수정  

* name이 Slime인 데이터의 hp값을 30으로 변경하기  
>```
>db.테이블명.update({ name: 'Slime' }, { $set: { hp: 30 } });
>```


* name이 Slime인 데이터의 hp값을 -5한 값으로 변경하기(기존 hp값에서 -5 계산한 값)  
>$inc를 사용하면 숫자를 올리거나 내릴 수 있습니다. 음수를 넣으면 내리고 양수를 넣으면 올립니다.  
>세 번째 인자로 옵션(multi와 upsert)을 넣을 수 있습니다.  
>multi는 여러 개를 동시에 수정할 때 사용합니다. { multi: true }  
>기본적으로는 한 다큐먼트만 수정하지만 만약 이름이 Slime인 다큐먼트가 여러 개 있다면 그 다큐먼트들을 모두 수정한다  
>```
>db.테이블명.update({ name: 'Slime' }, { $inc: { hp: -5 } });
>```


* name이 Demon 데이터의 att값을 150으로 변경하기(update, remove같이 수행가능, 적용 후 바로 결과 반환)  
>$inc를 사용하면 숫자를 올리거나 내릴 수 있습니다. 음수를 넣으면 내리고 양수를 넣으면 올립니다.  
>upsert과 remove까지 같이 수행  
>{ new: true }를 넣으면 수정 이후의 다큐먼트를 반환(결과 반환)
>```
>db.테이블명.findAndModify({ query: { name: 'Demon' }, update: { $set: { att: 150 } }, new: true });
>```


* UpdateOne  
>매칭되는 다큐먼트 중 첫 번째만 수정  
>name이 Slime 데이터 중 첫번째 데이터의 hp값을 25로 변경하기  
>```
>db.테이블명.updateOne({ name: 'Slime' }, { $set: { hp: 25 } });
>```


* UpdateMany  
>매칭되는 모든 다큐먼트를 수정  
>name이 Slime 데이터 모두 hp값을 25로 변경하기  
>```
>db.테이블명.updateMany({ name: 'Slime' }, { $set: { hp: 25 } });
>```


* ReplaceOne  
>다큐먼트를 통째로 다른 것으로 대체($set을 안 썼을 때 상황과 유사)  
>name이 Slime인 하나의 데이터를 오른쪽 Ribbon Pig 데이터로 바꿔버린다  
>```
>db.테이블명.replaceOne({ name: 'Slime' }, { name: 'Ribbon Pig', hp: 30, xp:25, att:30 });
>```


* FindOneAndUpdate(DB 3.2 버전)  
>하나의 다큐먼트를 update, upsert, remove를 모두 가능  
>기존 findAndModify의 옵션인 'new'의 이름이 'returnNewDocument'로 변경되었다.(기능은 같음)  
>name이 Demon인 데이터 중 하나를 att값을 150으로 변경하고 결과를 뿌려준다  
>```
>db.테이블명.findOneAndUpdate({ name: 'Demon' }, { $set: { att: 150 } }, { returnNewDocument: true }); 
>```


* FindOneAndReplace(DB 3.2 버전)  
>하나의 다큐먼트를 통째로 바꿔버린다  
>기존 ReplaceOne과 같은 기능  
>```
>db.테이블명.FindOneAndReplace({ name: 'Slime' }, { name: 'Ribbon Pig', hp: 30, xp:25, att:30 }, { returnNewDocument: true });
>```



* criteria에 해당되는 document가 존재하지 않는다면 새로 추가하기  
>upsert 옵션을 설정하여 Elly document가 존재하지 않으면 새로 추가  
>name이 Elly인 데이터를 찾아 있으면 age값을 17로 입력하고 없으면 해당 데이터를 새로 입력한다.  
>```
>db.테이블명.update( { name: "Elly" }, { name: "Elly", age: 17 }, { upsert: true } )
>```




* Upsert
> update + insert의 합성어  
> 특정한 옵션을 주어서 수정할 대상이 없는 경우 insert 동작을 수행
> Upsert 기능을 하려면 update, updateOne, updateMany, replaceOne 메소드에 옵션으로 { upsert: true } 를 주면 됩니다. 
> 또는 findAndModify, findOneAndUpdate, findOneAndReplace 메소드에 upsert: true를 추가할 수도 있습니다.  
> save와 insert 메소드의 차이가 upsert의 개념에 있습니다.  
> save는 upsert 메소드입니다. 만약 해당하는 다큐먼트가 없으면 새로 만듭니다. 하지만 해당하는 다큐먼트가 있으면(_id를 제공해야합니다) 수정합니다.  




* Remove  
>* 데이터를 모두 지운다  
>```
>db.테이블명.remove({ });
>```
>
>* 조건에 해당하는 데이터를 지운다  
>```
>db.테이블명.remove({ 컬럼명: "값" });
>```


* Remove(몽고DB 3.2 버전)  
>* 조건에 해당하는 데이터 하나만 지운다  
>```
>db.테이블명.deleteOne({ 컬럼명: "값" });
>```
>
>* 조건에 해당하는 데이터를 모두 지운다  
>```
>db.테이블명.deleteMany({ 컬럼명: "값" });
>```











* 특정 field를 제거하기  
>David document의 score field를 제거한다  
>```
>db.테이블명.update( { name: "David" }, { $unset: { score: 1 } } )
>```
>










>Option | 설명
>--- | ---
>i | 대소문자 무시
>m | 정규식에서 anchor(^) 를 사용 할 때 값에 \n 이 있다면 무력화
>x | 정규식 안에있는 whitespace를 모두 무시
>s | dot (.) 사용 할 떄 \n 을 포함해서 매치
>




---
##### 출처  
[https://www.zerocho.com/category/MongoDB/post/579e2821c097d015000404dc](https://www.zerocho.com/category/MongoDB/post/579e2821c097d015000404dc)  
[https://velopert.com/545](https://velopert.com/545)  
[https://www.zerocho.com/category/MongoDB/post/579ecb1fc097d015000404dd](https://www.zerocho.com/category/MongoDB/post/579ecb1fc097d015000404dd)  
[http://winmargo.tistory.com/182](http://winmargo.tistory.com/182)  


